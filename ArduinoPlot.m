% testStillMotorsOffDrift.txt
% senzor se ne pomera, motori NE RADE

% testStill.txt
% senzor se ne pomera, motori RADE

% testOscilations.txt
% kod 1 smo snimali signal da bismo odredili kolika je najveca frekvencija
% oscilacija, ali bez rada motora, a ostali imaju rad motora
% kod 2 je Tf=0.1786
% kod 3 je Tf=0.1
% kod 4 je Tf=0.05
% kod 5 je Tf=0.1
% kod 6 je Tf=0.1, tau=0.95
% kod 7 je Tf=0.1, tau=0.8187(isto kao i p)
% kod 8 je Tf=0.05, tau=0.67(isto ako i p)
% kod 9 su isti parametri kao iz 8 samo se ugao kretao od 15 stepeni do
% oko 90 ili 100, bez rada motora
% kod 10 smo imali pola snimanja uz rad pola bez rada motora. ovaj test
% sluzi da vidimo koji filtar je bolji kod snimanja bez rada motora

% testPWM.txt
% naizmenicno ukljucujemo i iskljucujemo motore

f = fopen('testPWM.txt', 'r');
[A, B] = fscanf(f, '%f %f %f %f %f %f %f %f %f %f %f %f', [12 Inf]);
angleAcc = A(1, :);
angleGyro = A(2, :);   % raw gyro
angleCompl = A(3, :);     % Kalaman output
angleKal = A(4, :);   % Complementary filter
angleFil = A(5, :);   % First order filter

dangleAcc = A(6, :);
dangleGyro = A(7, :);
dangleCompl = A(8, :);     % Kalaman output
dangleKal = A(9, :);   % Complementary filter
dangleFil = A(10, :);   % First order filter


% 
% angleAcc = angleAcc - 90;
% angleKal = angleKal - 90;
% angleFil = angleFil - 90;

T = A(11, :);
% T = 20E-3*ones(1, length(angleAcc));
t = cumsum(T);

u = A(12, :);
%% Simulacija komplementarnog
% tau = 0.67;
tau = 0.1/(20E-3 + 0.1);
% Od oko 40-og odbirka se poklapaju rezultati
angleComplSim = simulateComplementary(angleAcc, angleGyro, tau);
% plot(t, angleFil, t, angleComplSim, 'LineWidth', 1.3);
% legend(["?????? ????? ????", "??????????????"])
%% Simulacija filtra prvog reda
Ts = 20E-3;
Tf = 0.1;

% Tf = -Ts/(log(tau))
% Od oko 40-og odbirka se poklapaju rezultati
angleFilSim = simulateFirstOrderFil(angleAcc, Ts ,Tf);
% plot(t, angleFil, t, angleFilSim, 'LineWidth', 1.3);
% legend(["?????? ????? ????", "??????????"])
%% Uporedna analiza simulacija
figure
plot(t, angleFilSim, t, angleComplSim, 'LineWidth', 1.3);
legend(["I red", "compl"])
title("??????? ???? ?? ????? ??????, Tf=0.05s, tau=0.67");
xlabel("????? (???????)");

figure
plot(t, angleComplSim, t, angleKal, 'LineWidth', 1.3);
legend(["??????????????", "??????"])
title("??????? ???? ?? ????? ??????, Tf=0.05s, tau=0.67");
xlabel("????? (s)");
ylabel("????? (???????)");

figure
plot(t, angleAcc, t, angleComplSim, 'LineWidth', 1.3);
legend(["?????????????", "??????????????"])
title("??????? ???? ?? ????? ??????, tau=0.67");
xlabel("????? (s)");
ylabel("????? (???????)");

figure
difference = angleComplSim - angleFilSim;
plot(t, difference);
ylim([-10, 10])
title("??????? ?????? ??????????????? ? ?????? ????? ????, Tf=0.05s, tau=0.67");
xlabel("????? (s)");
ylabel("????? (???????)");

%% Stampanje promene ugla
close all
figure
% subplot(211)
plot(t, angleAcc, t, angleKal, t, u, 'LineWidth', 1.3);
% title("Promena ugla sa radom motora");
title("??????? ???? ?? PWM ??????");
% ylabel("Angle(deg)");
ylabel("????? (???????)");
xlabel("????? (???????)");
% legend(["Raw accelerometer", "Raw gyroscope"])
legend(["?????????????", "??????", "PWM"])

figure
% subplot(212)
plot(t, angleCompl, t, angleKal, t, u, 'LineWidth', 1.3);
% title("Promena ugla sa radom motora");
title("??????? ???? ?? ????? ??????, tau=0.8187");
xlabel("????? (s)");
% ylabel("Angle(deg)");
ylabel("????? (???????)");
% legend(["Raw accelerometer", "Raw gyroscope", "PWM"])
legend(["compl", "kalman"])
ylim([-50 150])

figure
% subplot(311)
plot(t, angleCompl, t, angleFil, 'LineWidth', 1.3);
% title("Promena ugla sa radom motora");
title("??????? ???? ?? ? ??? ???? ??????, Tf=0.05s, tau=0.67");
xlabel("????? (s)");
% ylabel("Angle(deg)");
ylabel("????? (???????)");
% legend(["Raw accelerometer", "Complementary", "Kalman"])
legend(["??????????????", "?????? ????? ????"])

figure
% subplot(311)
plot(t, angleAcc, t, angleGyro, 'LineWidth', 1.3);
% title("Promena ugla sa radom motora");
title("??????? ???? ?? ????? ??????");
xlabel("????? (s)");
% ylabel("Angle(deg)");
ylabel("????? (???????)");
% legend(["Raw accelerometer", "Complementary", "Kalman"])
legend(["?????????????", "????????"])

figure
% subplot(311)
plot(t, angleAcc, t, angleFil, 'LineWidth', 1.3);
% title("Promena ugla sa radom motora");
title("??????? ???? ?? ????? ??????, Tf=0.05s");
xlabel("????? (s)");
% ylabel("Angle(deg)");
ylabel("????? (???????)");
% legend(["Raw accelerometer", "Complementary", "Kalman"])
legend(["?????????????", "?????? ????? ????"])
%% Gausove raspodele ulaznog signala

% histfit(angleAcc)
figure
% subplot(311)
histogram(angleAcc, 100);
title("????????? ?????? ???? ????????? ?????? ?????????????, ?? ????? ??????");
xlabel("????? (???????)");
ylabel("???? ??????????? ?????????");

figure
% subplot(312)
histogram(angleGyro);
title("Raspodela merenja ugla racunatog pomocu ziroskopa, uz rad motora, mirno stanje");
xlabel("Ugao(deg)");
% xlim([-5 0])

figure
% subplot(313)
histogram(angleFil);
title("Raspodela merenja ugla racunatog pomocu First order, uz rad motora, mirno stanje");
xlabel("Ugao(deg)");

%% 
edges = unique(angleAcc)
counts = histc(angleAcc(:), edges)
plot(edges, counts);
%%
x = angleGyro;
fs = 1/(20E-3);

X = fft(x);
f_osa = linspace(0, fs, length(X));

X2  = fftshift(X);
f_osa2 = linspace(-fs/2, fs/2, length(X));

figure
stem(f_osa2, abs(X2))
title("??????? ??????? ?? ????????????? ?? ??? ??????, ??????? ????????? 20ms")
xlabel("??????????? (Hz)")

% podaci = angleAcc';
% pd = fitdist(podaci,'Normal');
% [mu,sigma,muCI,sigmaCI] = normfit(x);
% t = -3*sigmaHat:0.01:3*sigmaHat;
% y = normpdf(t, muHat, sigmaHat);
% figure
% plot(t,y)
%%
% % figure, 
% subplot(312)
% plot(t, angleKal, t, angleFil, t, u, 'LineWidth', 1.3);
% % title("Promena ugla, sa radom motora, tau=0.99");
% xlabel("t(s)");
% ylabel("Angle(deg)");
% legend(["Kalman","Djordje","PWM"])

% % figure
% subplot(313)
% plot(t, angleAcc, t, angleFil, t, u, 'LineWidth', 1.3);
% % title("Promena ugla, sa radom motora, tau=0.99");
% xlabel("t(s)");
% ylabel("Angle(deg)");
% legend(["Original","Djordje","PWM"])

%% Stampane promene ugaone brzine
figure
% subplot(311)
plot(t, dangleAcc, t, dangleGyro, 'LineWidth', 1.3);
title("??????? ?????? ?????? ?? ????? ??????");
xlabel("????? (s)");
ylabel("????? (???????/s)");
legend(["?????????????", "????????"])
% 
figure
% subplot(312)
plot(t, dangleAcc, t, dangleCompl, t, u, 'LineWidth', 1.3);
% title("Promena ugla, sa radom motora, tau=0.99");
xlabel("t(s)");
ylabel("Angle(deg/s)");
legend(["Original","Complementary","PWM"])

figure
% subplot(313)
plot(t, dangleAcc, t, dangleKal, t, u, 'LineWidth', 1.3);
% title("Promena ugla, sa radom motora, tau=0.99");
xlabel("t(s)");
ylabel("Angle(deg/s)");
legend(["Original","Kalman","PWM"])
